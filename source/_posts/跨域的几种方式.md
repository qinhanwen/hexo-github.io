---
title: è·¨åŸŸçš„å‡ ç§æ–¹å¼
date: 2018-11-27 12:10:17
tags: 
- æ·±å…¥å­¦ä¹ 
categories: 
- è·¨åŸŸ
---

# è·¨åŸŸçš„å‡ ç§æ–¹å¼

> å‚è€ƒèµ„æ–™ï¼šhttps://www.bilibili.com/video/av31173487?from=search&seid=17845079103401026420
>
> â€‹                   http://www.ruanyifeng.com/blog/2016/04/cors.html

è¿™é‡Œåç«¯å…¨éƒ¨ä½¿ç”¨[koa](https://qinhanwen.github.io/2018/11/16/koa%E5%85%A5%E9%97%A8/),å†™çš„åªæ˜¯ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œå¾ˆå¤šå®é™…ä¸­ä¸åº”è¯¥è¿™æ ·å†™ã€‚ä¾‹å­é‡å¤ä»£ç å¤ªå¤šï¼Œä½†æ˜¯ç›´æ¥ç²˜è´´å°±å¯ä»¥æµ‹è¯•ã€‚

#### 1.JSONP

#####  1) ä¸¾ä¸ªğŸŒ°ï¼Œæ‰“å¼€ç™¾åº¦æœç´¢

![](http://www.qinhanwen.xyz/images/WX20181217-134405@2x.png)



å¯ä»¥çœ‹è§è¯·æ±‚ä¸åœ¨XHRå†…ï¼Œè¯·æ±‚åœ°å€ä¸ºï¼š[https://sp0.baidu.com/5a1Fazu8AA54nxGko9WTAnF6hhy/su?wd=12334&sugmode=2&json=1&p=3&sid=26522_1448_27209_21127_28131_27751&req=2&bs=12334&pbs=12334&csor=5&pwd=12334&cb=jQuery110209787636885175626_1545020875748&_=1545020875776](https://sp0.baidu.com/5a1Fazu8AA54nxGko9WTAnF6hhy/su?wd=12334&sugmode=2&json=1&p=3&sid=26522_1448_27209_21127_28131_27751&req=2&bs=12334&pbs=12334&csor=5&pwd=12334&cb=jQuery110209787636885175626_1545020875748&_=1545020875776)



ä¿®æ”¹ä¸€ä¸‹è¯·æ±‚åœ°å€çš„æŸ¥è¯¢å‚æ•°`cb`éƒ¨åˆ†

[https://sp0.baidu.com/5a1Fazu8AA54nxGko9WTAnF6hhy/su?wd=12334&sugmode=2&json=1&p=3&sid=26522_1448_27209_21127_28131_27751&req=2&bs=12334&pbs=12334&csor=5&pwd=12334&cb=show](https://sp0.baidu.com/5a1Fazu8AA54nxGko9WTAnF6hhy/su?wd=12334&sugmode=2&json=1&p=3&sid=26522_1448_27209_21127_28131_27751&req=2&bs=12334&pbs=12334&csor=5&pwd=12334&cb=show)



ä»£ç å¦‚ä¸‹ï¼š

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>

    <script>
        function show(data) {
            console.log(data);
        }
    </script>
    <script src="https://sp0.baidu.com/5a1Fazu8AA54nxGko9WTAnF6hhy/su?wd=12334&sugmode=2&json=1&p=3&sid=26522_1448_27209_21127_28131_27751&req=2&bs=12334&pbs=12334&csor=5&pwd=12334&cb=show"></script>

</body>

</html>
```

æœ€åæ‰“å°å‡ºç»“æœ

![](http://www.qinhanwen.xyz/images/WX20181217-134554@2x.png)



##### 2) å®ç°ä¸€ä¸ªç®€å•JSONPä¾‹å­

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>

    <button onclick="send()">send</button>

</body>
<script>
    function show(data) {
        console.log(data);//è¿™ä¸ªæ˜¯æ•°æ®
    }
</script>
<script>
    function send() {
     var script = document.createElement('script');
     script.setAttribute('src','http://127.0.0.1:3000/jsonp?callback=show');
     document.body.appendChild(script);
    }
</script>

</html>
```

koaéƒ¨åˆ†ï¼š

```js
const koa = require('koa');
const app = new koa();

const Router = require('koa-router');
const router = new Router();

router.get('/jsonp', async (ctx, next) => {
    const req = ctx.request.query;
    console.log(req);
    const data = 'è¿™ä¸ªæ˜¯æ•°æ®';
    ctx.body = req.callback + '(' + JSON.stringify(data) + ')';//show("è¿™ä¸ªæ˜¯æ•°æ®")
})

app.use(router.routes());

app.listen(3000);
console.log('koa server is listening port 3000');
```



##### 3)å°è£…ä¸€ä¸ªJSONPå‡½æ•°

å†™å®Œä»¥åæ„Ÿè§‰ï¼Œè¿™å†™çš„ä»€ä¹ˆé¬¼ï¼Œæˆ‘å¤§æ¦‚æ˜¯å¿˜äº†æƒ³å†™ä»€ä¹ˆã€‚

```javascript
    function jsonp(url, params, cb) {
        return new Promise((resolve, reject) => {
            if (typeof url !== "string" || typeof cb !== "function" || !(params instanceof Object)) {
                reject('å‚æ•°é”™è¯¯');
                return;
            }
            let script = document.createElement('script');
            let str = '';
            const paramsArray = Object.keys(params);

            if (paramsArray.length) {
                paramsArray.forEach((item) => {
                    str += `${item}=${params[item]}&`;
                })
            }
            script.setAttribute('src', `${url}?${str}cb=${cb.name}`);
            document.body.appendChild(script);
            script.onload = () => {
                resolve(script);
            }
            script.onerror = () => {
                reject('é”™è¯¯');
            }
        })
    }
	//

function show(data) {
    console.log(data);
}
	//


jsonp('http://127.0.0.1:3000/jsonp', { data: 1 }, show).then(function (script) {
    console.log(1);
    document.body.removeChild(script);
}).catch(err => {
    console.log(err);
})

```



å¤åˆ¶ä¸€ä¸‹è§†é¢‘é‡Œè€å¸ˆå†™çš„

```javascript
function jsonp1({url,params,cb}) {
    return new Promise((resolve, reject) => {
        let script = document.createElement('script');
        window[cb] = function(data){
            resolve(data);
            document.body.removeChild(script);
        }
        params = {...params,cb};
        let arrs = [];
        for(let key in params){
            arrs.push(`${key}=${params[key]}`);
        }
        script.src = `${url}?${arrs.join('&')}`;
        document.body.appendChild(script);
    })
}
```



##### 4) JSONPçš„ç¼ºç‚¹

1.å¿…é¡»ä¼ å›è°ƒå‡½æ•°åç§°

2.åªæ”¯æŒgetè¯·æ±‚

3.ä¸å®‰å…¨ XSSæ”»å‡»





#### 2.CORSï¼ˆæœ€å¸¸ç”¨ï¼Œå®‰å…¨æ€§é«˜ï¼‰

##### 1ï¼‰å…ˆå†™ä¸€ä¸ªç®€å•ğŸŒ°,ä¸€ä¸ªgetçš„è¯·æ±‚ï¼ˆä»£ç éƒ½æ˜¯åŸºäºå‰ä¸€ä¸ªçš„åŸºç¡€ä¸Šä¿®æ”¹ï¼‰

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
</body>
<script>
    function send() {
        var xmlHttp;
        if (XMLHttpRequest) {
            xmlHttp = new XMLHttpRequest();
        } else {
            xmlHttp = new ActiveXObject();
        }

        xmlHttp.onreadystatechange = function () {
            if (xmlHttp.readyState == 4) {
                if ((xmlHttp.status >= 200 && xmlHttp.status <= 300) || xmlHttp.status == 304) {
                    console.log(xmlHttp.response);
                }
            }
        }

        xmlHttp.open('GET', 'http://127.0.0.1:3000/cors', true);
        xmlHttp.send();
    }

    send();
</script>

</html>
```

koaéƒ¨åˆ†ï¼š

```javascript
const koa = require('koa');
const app = new koa();

const Router = require('koa-router');
const router = new Router();

router.get('/cors', async (ctx, next) => {
    console.log(ctx.headers);
    ctx.body = {
        success:true
    };
})
app.use(router.routes());

app.listen(3000);
console.log('koa server is listening port 3000');
```

è¿è¡Œä»£ç ï¼Œå‘é€è¯·æ±‚çš„æ—¶å€™å¯ä»¥çœ‹åˆ°æµè§ˆå™¨, `Access-Control-Allow-Origin`ã€‚è¡¨ç¤ºåå°æ²¡æœ‰å…è®¸åŸŸçš„è®¿é—®ã€‚

![](http://www.qinhanwen.xyz/images/WX20181129-215645@2x.png)



åŒæ—¶ä¹Ÿå¯ä»¥çœ‹åˆ°åå°æ‰“å°å‡ºæ¥çš„ç»“æœ

![](http://www.qinhanwen.xyz/images/WX20181129-223122@2x.png)



å¯ä»¥çœ‹å‡ºå…¶å®ajaxè¯·æ±‚å·²ç»å‘å‡ºï¼Œåªæ˜¯è¿”å›çš„æ—¶å€™è¢«æµè§ˆå™¨å±è”½ã€‚å›¾ä¸­å¯ä»¥çœ‹åˆ°è®¿é—®æœåŠ¡å™¨çš„æ¥æºã€‚



**è§£å†³æ–¹æ¡ˆï¼š**

æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªwhiteListï¼ˆç™½åå•ï¼‰ï¼Œå¹¶ä¸”åˆ¤æ–­å¦‚æœæ¥æºåœ¨ç™½åå•å†…ï¼Œå°±è®¾ç½®å“åº”å¤´ã€‚

```javascript
const koa = require('koa');
const app = new koa();

const Router = require('koa-router');
const router = new Router();

//æ–°å¢çš„éƒ¨åˆ†
const whiteList = ['http://localhost:8000'];
app.use((ctx,next)=>{
    let origin = ctx.headers.origin;
    if (whiteList.includes(origin)) {//å¦‚æœåˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œä¸å»ºè®®ä½¿ç”¨indexOf
        console.log(origin)
        ctx.set('Access-Control-Allow-Origin', origin);
    }
    next();
})
//

router.get('/cors', async (ctx, next) => {
    
    ctx.body = {
        success: true
    };
})

app.use(router.routes());

app.listen(3000);
console.log('koa server is listening port 3000');
```

å¯ä»¥çœ‹åˆ°è¯·æ±‚æˆåŠŸäº†

![](http://www.qinhanwen.xyz/images/WX20181129-225339@2x.png)



##### 2ï¼‰ç¬¬äºŒä¸ªğŸŒ°ï¼Œè‡ªå®šä¹‰è¯·æ±‚å¤´

ä¸ä¿®æ”¹koaä»£ç çš„æƒ…å†µä¸‹ï¼Œä¿®æ”¹htmlã€‚

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
</body>
<script>
    function send() {
        var xmlHttp;
        if (XMLHttpRequest) {
            xmlHttp = new XMLHttpRequest();
        } else {
            xmlHttp = new ActiveXObject();
        }
       
        xmlHttp.onreadystatechange = function () {
            if (xmlHttp.readyState == 4) {
                if ((xmlHttp.status >= 200 && xmlHttp.status <= 300) || xmlHttp.status == 304) {
                    console.log(xmlHttp.response);
                }
            }
        }
        xmlHttp.open('GET', 'http://127.0.0.1:3000/cors', true);
        //æ–°å¢çš„éƒ¨åˆ†
        xmlHttp.setRequestHeader('name','qinhanwen');//å¿…é¡»åœ¨opendä»¥åæ‰å¯ä»¥è®¾ç½®
        //
        xmlHttp.send();
    }

    send();
</script>

</html>
```



è¯·æ±‚å‘é€åçœ‹åˆ°æŠ¥é”™`OPTIONS`è¯·æ±‚æŒ‚äº†

![](http://www.qinhanwen.xyz/images/WX20181129-233857@2x.png)



**é—®é¢˜åŸå› **ï¼šéç®€å•è¯·æ±‚ï¼Œä¼šå…ˆå‘é€ä¸€ä¸ª`OPTIONS`é¢„è¯·æ±‚ã€‚



**è§£å†³æ–¹æ¡ˆ**ï¼š

```javascript
const koa = require('koa');
const app = new koa();

const Router = require('koa-router');
const router = new Router();


const whiteList = ['http://localhost:8000'];

//æ–°å¢çš„éƒ¨åˆ†ï¼ŒOPTIONSè¯·æ±‚ç›´æ¥æ”¾è¿‡
app.use( (ctx, next) => {
    if (ctx.method === 'OPTIONS') {
    ctx.body = '';
    }
     next();
   });
//

app.use((ctx,next)=>{
    let origin = ctx.headers.origin;
    if (whiteList.includes(origin)) {
        console.log(origin)
        ctx.set('Access-Control-Allow-Origin', origin);
    }
    next();
})



router.get('/cors', async (ctx, next) => {
    
    ctx.body = {
        success: true
    };
})

app.use(router.routes());

app.listen(3000);
console.log('koa server is listening port 3000');
```



ç„¶ååˆå‡ºç°äº†æ–°çš„æŠ¥é”™`Access-Control-Allow-Headers`,å¤´éƒ¨ä¸è¢«å…è®¸ã€‚

![](http://www.qinhanwen.xyz/images/WX20181130-131904@2x.png)



**è§£å†³æ–¹æ¡ˆ**ï¼šè®¾ç½®å…è®¸çš„è¯·æ±‚å¤´éƒ¨ï¼Œå¤šä¸ªå¤´éƒ¨ä½¿ç”¨`é€—å·`åˆ†éš”

```javascript
const koa = require('koa');
const app = new koa();

const Router = require('koa-router');
const router = new Router();


const whiteList = ['http://localhost:8000'];

app.use( (ctx, next) => {
    if (ctx.method === 'OPTIONS') {
    ctx.body = '';
    }
     next();
   });

app.use((ctx,next)=>{
    let origin = ctx.headers.origin;
    if (whiteList.includes(origin)) {
        console.log(origin)
        ctx.set('Access-Control-Allow-Origin', origin);
        //æ–°å¢çš„éƒ¨åˆ†
        ctx.set('Access-Control-Allow-Headers', "name,age");
        //
    }
    next();
})
router.get('/cors', async (ctx, next) => {
    
    ctx.body = {
        success: true
    };
})

app.use(router.routes());

app.listen(3000);
console.log('koa server is listening port 3000');
```

å¯ä»¥çœ‹åˆ°è¯·æ±‚æˆåŠŸäº†

![](http://www.qinhanwen.xyz/images/WX20181217-124231@2x.png)



##### 3ï¼‰ç¬¬ä¸‰ä¸ªğŸŒ°ï¼Œå‘ä¸€ä¸ªPUTè¯·æ±‚

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
</body>
<script>
    function send() {
        var xmlHttp;
        if (XMLHttpRequest) {
            xmlHttp = new XMLHttpRequest();
        } else {
            xmlHttp = new ActiveXObject();
        }
       
        xmlHttp.onreadystatechange = function () {
            if (xmlHttp.readyState == 4) {
                if ((xmlHttp.status >= 200 && xmlHttp.status <= 300) || xmlHttp.status == 304) {
                    console.log(xmlHttp.response);
                }
            }
        }
        //ä¿®æ”¹çš„éƒ¨åˆ†
        xmlHttp.open('PUT', 'http://127.0.0.1:3000/cors', true);
        //
        xmlHttp.setRequestHeader('name','qinhanwen');
        xmlHttp.send();
    }

    send();
</script>

</html>
```

åŒæ—¶æ¥æ”¶ä¸€ä¸ªPUTè¯·æ±‚

```javascript
const koa = require('koa');
const app = new koa();

const Router = require('koa-router');
const router = new Router();


const whiteList = ['http://localhost:8000'];

app.use( (ctx, next) => {
    if (ctx.method === 'OPTIONS') {
    ctx.body = '';
    }
     next();
   });

app.use((ctx,next)=>{
    let origin = ctx.headers.origin;
    if (whiteList.includes(origin)) {//å¦‚æœåˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œä¸å»ºè®®ä½¿ç”¨indexOf
        console.log(origin)
        ctx.set('Access-Control-Allow-Origin', origin);
        ctx.set('Access-Control-Allow-Headers', "name,age");
    }
    next();
})

//æ–°å¢çš„éƒ¨åˆ†
router.put('/cors' ,async (ctx, next) => {
    
    ctx.body = {
        success: true
    };
})
//


router.get('/cors', async (ctx, next) => {
    
    ctx.body = {
        success: true
    };
})

app.use(router.routes());

app.listen(3000);
console.log('koa server is listening port 3000');
```



ç„¶åå‡ºç°äº†æŠ¥é”™`Access-Control-Allow-Methods`ã€‚è¯·æ±‚æ–¹æ³•ä¸å…è®¸ã€‚

![](http://www.qinhanwen.xyz/images/WX20181130-174602@2x.png)



**è§£å†³æ–¹æ¡ˆ**ï¼š

```javascript
const koa = require('koa');
const app = new koa();

const Router = require('koa-router');
const router = new Router();


const whiteList = ['http://localhost:8000'];

app.use( (ctx, next) => {
    if (ctx.method === 'OPTIONS') {
    ctx.body = '';
    }
     next();
   });

app.use((ctx,next)=>{
    let origin = ctx.headers.origin;
    if (whiteList.includes(origin)) {//å¦‚æœåˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œä¸å»ºè®®ä½¿ç”¨indexOf
        console.log(origin)
        ctx.set('Access-Control-Allow-Origin', origin);
        ctx.set('Access-Control-Allow-Headers', "name,age");
        //æ–°å¢çš„éƒ¨åˆ†
        ctx.set('Access-Control-Allow-Methods', "PUT");
        //
    }
    next();
})
router.put('/cors' ,async (ctx, next) => {
    
    ctx.body = {
        success: true
    };
})

router.get('/cors', async (ctx, next) => {
    
    ctx.body = {
        success: true
    };
})

app.use(router.routes());

app.listen(3000);
console.log('koa server is listening port 3000');
```



å¯ä»¥çœ‹åˆ°è¯·æ±‚æˆåŠŸäº†

![](http://www.qinhanwen.xyz/images/WX20181130-175914@2x.png)



###### äº†è§£ä¸€ä¸‹`OPTIONS`è¯·æ±‚

åœ¨éç®€å•è¯·æ±‚çš„æ—¶å€™ï¼Œä¼šå…ˆå‘é€ä¸€ä¸ªé¢„è¯·æ±‚ï¼Œä¸»è¦ç”¨æ¥åˆ¤æ–­æ˜¯å¦å…è®¸è·¨åŸŸï¼ˆæˆ‘è®¤ä¸ºå°±æ˜¯è¯¢é—®åå°å“ªäº›å¤´éƒ¨ï¼Œæ–¹æ³•å’Œæ¥æºæ˜¯è¢«å…è®¸çš„ï¼‰ã€‚



åœ¨å¤šæ¬¡å¼ºåˆ¶åˆ·æ–°é¡µé¢çš„æ—¶å€™ä¼šå‘ç°ï¼Œå¹¶ä¸æ˜¯æ¯æ¬¡è¯·æ±‚çš„æ—¶å€™éƒ½ä¼šå‘é€`OPTIONS`è¯·æ±‚ï¼Œæœ‰æ—¶å€™ä¼šå‘é€

![](http://www.qinhanwen.xyz/images/WX20181130-180931@2x.png)



æœ‰æ—¶ä¸ä¼šå‘é€

![](http://www.qinhanwen.xyz/images/WX20181130-181123@2x.png)



**é—®é¢˜åŸå› **ï¼šæµè§ˆå™¨ä¼šåŠ ä¸Šä¸€ä¸ªé»˜è®¤çš„æ—¶é—´ï¼Œä¹Ÿå¯ä»¥é€šè¿‡`Access-Control-Max-Age`è®¾ç½®

```javascript
const koa = require('koa');
const app = new koa();

const Router = require('koa-router');
const router = new Router();


const whiteList = ['http://localhost:8000'];

app.use( (ctx, next) => {
    if (ctx.method === 'OPTIONS') {
    ctx.body = '';
    }
     next();
   });

app.use((ctx,next)=>{
    let origin = ctx.headers.origin;
    if (whiteList.includes(origin)) {
        console.log(origin)
        ctx.set('Access-Control-Allow-Origin', origin);
        ctx.set('Access-Control-Allow-Headers', "name,age");
        ctx.set('Access-Control-Allow-Methods', "PUT");
        //æ–°å¢çš„éƒ¨åˆ†
        ctx.set('Access-Control-Max-Age', 60);//è¿™é‡Œè®¾ç½®äº†60ç§’å†…ä¸ä¼šå†å‘é€
        //
    }
    next();
})

router.put('/cors' ,async (ctx, next) => {
    ctx.body = {
        success: true
    };
})

router.get('/cors', async (ctx, next) => {
    
    ctx.body = {
        success: true
    };
})

app.use(router.routes());

app.listen(3000);
console.log('koa server is listening port 3000');
```



##### 4ï¼‰ç¬¬å››ä¸ªğŸŒ°,è®¾ç½®cookie

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
</body>
<script>
    function send() {
        var xmlHttp;
        if (XMLHttpRequest) {
            xmlHttp = new XMLHttpRequest();
        } else {
            xmlHttp = new ActiveXObject();
        }
       
        xmlHttp.onreadystatechange = function () {
            if (xmlHttp.readyState == 4) {
                if ((xmlHttp.status >= 200 && xmlHttp.status <= 300) || xmlHttp.status == 304) {
                    console.log(xmlHttp.response);
                }
            }
        }
        //æ–°å¢çš„å†…å®¹
        document.cookie = "user=qinhanwen";
        //
        xmlHttp.open('PUT', 'http://127.0.0.1:3000/cors', true);
        xmlHttp.setRequestHeader('name','qinhanwen');//å¿…é¡»åœ¨opendä»¥åæ‰å¯ä»¥è®¾ç½®
        xmlHttp.send();
    }

    send();
</script>

</html>
```

åœ¨åå°æŠŠè¯·æ±‚å¤´æ‰“å°å‡ºæ¥çœ‹çœ‹ï¼Œå—¯ï¼æ¯›éƒ½æ²¡çœ‹åˆ°

![](http://www.qinhanwen.xyz/images/WX20181130-200234@2x.png)

**é—®é¢˜åŸå› **ï¼šå› ä¸º`cookie`æ˜¯ä¸å…è®¸è·¨åŸŸçš„ï¼ˆéœ€è¦æµè§ˆå™¨å’ŒæœåŠ¡å™¨åŒæ—¶å…è®¸ï¼‰ã€‚



**è§£å†³æ–¹æ¡ˆ**ï¼šæˆ‘éè¦åŠ ä¸Š,è®¾ç½® `withCredentials`

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
</body>
<script>
    function send() {
        var xmlHttp;
        if (XMLHttpRequest) {
            xmlHttp = new XMLHttpRequest();
        } else {
            xmlHttp = new ActiveXObject();
        }
       
        xmlHttp.onreadystatechange = function () {
            if (xmlHttp.readyState == 4) {
                if ((xmlHttp.status >= 200 && xmlHttp.status <= 300) || xmlHttp.status == 304) {
                    console.log(xmlHttp.response);
                }
            }
        }
        document.cookie = "user=qinhanwen";
        //æ–°å¢çš„éƒ¨åˆ†
        xmlHttp.withCredentials = true;
        //
        xmlHttp.open('PUT', 'http://127.0.0.1:3000/cors', true);
        xmlHttp.setRequestHeader('name','qinhanwen');//å¿…é¡»åœ¨opendä»¥åæ‰å¯ä»¥è®¾ç½®
        xmlHttp.send();
    }

    send();
</script>

</html>
```

çœ‹åˆ°çš„æŠ¥é”™`Access-Control-Allow-Credentials`ï¼Œ

![](http://www.qinhanwen.xyz/images/WX20181217-124407@2x.png)



**è§£å†³æ–¹æ¡ˆ**ï¼šæ·»åŠ å¤´

```javascript
const koa = require('koa');
const app = new koa();

const Router = require('koa-router');
const router = new Router();


const whiteList = ['http://localhost:8000'];

app.use( (ctx, next) => {
    if (ctx.method === 'OPTIONS') {
    ctx.body = '';
    }
     next();
   });

app.use((ctx,next)=>{
    console.log(ctx.headers);
    let origin = ctx.headers.origin;
    if (whiteList.includes(origin)) {//å¦‚æœåˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œä¸å»ºè®®ä½¿ç”¨indexOf
        ctx.set('Access-Control-Allow-Origin', origin);
        ctx.set('Access-Control-Allow-Headers', "name,age");
        ctx.set('Access-Control-Allow-Methods', "PUT");
        //æ–°å¢çš„éƒ¨åˆ†
        ctx.set('Access-Control-Allow-Credentials',true);
        //
        ctx.set('Access-Control-Max-Age', 60);
    }
    next();
})

router.put('/cors' ,async (ctx, next) => {
    
    ctx.body = {
        success: true
    };
})

router.get('/cors', async (ctx, next) => {
    
    ctx.body = {
        success: true
    };
})

app.use(router.routes());

app.listen(3000);
console.log('koa server is listening port 3000');
```

å¯ä»¥çœ‹åˆ°è¯·æ±‚æˆåŠŸäº†

![](http://www.qinhanwen.xyz/images/WX20181201-145604@2x.png)



ç„¶è€Œï¼Œè¿˜æ˜¯æ²¡åœ¨è¯·æ±‚å¤´é‡Œçœ‹åˆ°`cookie`,è¿™ä¸ªé—®é¢˜åŠå¤©æ²¡æŸ¥æ˜ç™½ã€‚çŒœæµ‹æ˜¯åªèƒ½å¸¦ä¸ŠæœåŠ¡å™¨è®¾ç½®äº†çš„cookieï¼Œæ²¡æ·»åŠ çš„è¯å°±ä¸è¡Œï¼Œå…ˆè®°ç€åé¢æ¥è¡¥å……ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼Œåé¢æ¥è¡¥å……ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼Œåé¢æ¥è¡¥å……ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼





##### 5ï¼‰è®¾ç½®å“åº”å¤´

åœ¨è®¿é—®æŸäº›æ¥å£çš„æ—¶å€™ï¼Œå¯èƒ½æ•°æ®æ”¾åœ¨äº†å“åº”å¤´é‡Œã€‚

```javascript
const koa = require('koa');
const app = new koa();

const Router = require('koa-router');
const router = new Router();


const whiteList = ['http://localhost:8000'];

app.use((ctx, next) => {
    if (ctx.method === 'OPTIONS') {
        ctx.body = '';
    }
    next();
});

app.use((ctx, next) => {
    let origin = ctx.headers.origin;
    if (whiteList.includes(origin)) {//å¦‚æœåˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œä¸å»ºè®®ä½¿ç”¨indexOf
        ctx.set('Access-Control-Allow-Origin', origin);
        ctx.set('Access-Control-Allow-Headers', "name,age");
        ctx.set('Access-Control-Allow-Methods', "PUT");
        ctx.set('Access-Control-Allow-Credentials', true);
        ctx.set('Access-Control-Max-Age', 60);
    }
    next();
})

router.put('/cors', async (ctx, next) => {
    //æ–°å¢çš„éƒ¨åˆ†
    ctx.set('response','data');//è®¾ç½®å“åº”å¤´
    //
    ctx.body = {
        success: true
    };
})

router.get('/cors', async (ctx, next) => {

    ctx.body = {
        success: true
    };
})

app.use(router.routes());

app.listen(3000);
console.log('koa server is listening port 3000');
```



å‰ç«¯éƒ¨åˆ†ç›´æ¥ä»å“åº”å¤´ä¸­å–å€¼

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
</body>
<script>
    function send() {
        var xmlHttp;
        if (XMLHttpRequest) {
            xmlHttp = new XMLHttpRequest();
        } else {
            xmlHttp = new ActiveXObject();
        }

        xmlHttp.onreadystatechange = function () {
            if (xmlHttp.readyState == 4) {
                if ((xmlHttp.status >= 200 && xmlHttp.status <= 300) || xmlHttp.status == 304) {
                    console.log(xmlHttp.response);
                    //æ–°å¢çš„éƒ¨åˆ†
                    console.log(xmlHttp.getResponseHeader('response'));
                    //
                }
            }
        }
        document.cookie = "user=qinhanwen";
        xmlHttp.withCredentials = true;
        xmlHttp.open('PUT', 'http://127.0.0.1:3000/cors', true);
        xmlHttp.setRequestHeader('name', 'qinhanwen');//å¿…é¡»åœ¨opendä»¥åæ‰å¯ä»¥è®¾ç½®
        xmlHttp.send();
    }

    send();
</script>

</html>
```

çœ‹åˆ°æŠ¥é”™ ,ä¸å…è®¸è·å¾—ä¸å®‰å…¨çš„å¤´

![](http://www.qinhanwen.xyz/images/WX20181201-233454@2x.png)



**è§£å†³æ–¹æ¡ˆ**ï¼šæˆ‘å¤©çœŸçš„ä»¥ä¸ºè¿™ç§é—®é¢˜ï¼Œçœ‹èµ·æ¥åº”è¯¥æ˜¯å‰ç«¯è§£å†³çš„ï¼Œç„¶é¹…ï¼Œè¿˜æ˜¯è¦è®¾ç½®å“åº”å¤´`Access-Control-Expose-Headers`

```javascript
const koa = require('koa');
const app = new koa();

const Router = require('koa-router');
const router = new Router();


const whiteList = ['http://localhost:8000'];

app.use((ctx, next) => {
    if (ctx.method === 'OPTIONS') {
        ctx.body = '';
    }
    next();
});

app.use((ctx, next) => {
    let origin = ctx.headers.origin;
    if (whiteList.includes(origin)) {//å¦‚æœåˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œä¸å»ºè®®ä½¿ç”¨indexOf
        ctx.set('Access-Control-Allow-Origin', origin);
        ctx.set('Access-Control-Allow-Headers', "name,age");
        ctx.set('Access-Control-Allow-Methods', "PUT");
        ctx.set('Access-Control-Allow-Credentials', true);
        ctx.set('Access-Control-Max-Age', 60);
        //æ–°å¢çš„éƒ¨åˆ†
        ctx.set('Access-Control-Expose-Headers', 'response');
        //
    }
    next();
})

router.put('/cors', async (ctx, next) => {
    ctx.set('response', 'data');
    ctx.body = {
        success: true
    };
})

router.get('/cors', async (ctx, next) => {

    ctx.body = {
        success: true
    };
})

app.use(router.routes());

app.listen(3000);
console.log('koa server is listening port 3000');
```

å¯ä»¥çœ‹åˆ°è¯·æ±‚æˆåŠŸäº†

![](http://www.qinhanwen.xyz/images/WX20181202-095318@2x.png)



#### 3.postMessage

##### 1) ä½¿ç”¨postMessageè¿›è¡Œä¸åŒåŸŸé¡µé¢ä¹‹é—´çš„é€šä¿¡

é¦–å…ˆæ–°å»ºä¸¤ä¸ªé¡µé¢: 

ç¬¬ä¸€ä¸ªpostMessage.htmlï¼Œè¿™ä¸ªé¡µé¢iframeå¼•å…¥ç¬¬äºŒä¸ªé¡µé¢çš„åœ°å€ï¼Œå¹¶ä¸”å‘ç¬¬äºŒä¸ªé¡µé¢æ¨é€ã€‚

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <iframe src="http://localhost:8001/postMessage/postMessage1.html" id="frame"></iframe>
</body>
<script>
window.onload = function(){
   const frame = document.getElementById('frame');
   frame.contentWindow.postMessage('qinhanwen','http://localhost:8001');
}

</script>
</html>
```



å’ŒpostMessage1.htmlï¼Œè¿™ä¸ªé¡µé¢ç›‘å¬ä¼ å…¥çš„æ¶ˆæ¯

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>

</body>
<script>
     window.onmessage = function(e){
        console.log(e.data);//qinhanwen
    }
</script>
</html>
```

ç›®å½•ç»“æ„æ˜¯è¿™æ ·çš„,æˆ‘ä»¬ä½¿ç”¨puerï¼ˆå®‰è£…ï¼šnpm install puerï¼‰å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨ï¼Œè®©ä¸¤ä¸ªé¡µé¢çš„ç«¯å£å·ä¸åŒã€‚

![](http://www.qinhanwen.xyz/images/WX20181202-122824@2x.png)





##### 2)å†…åµŒé¡µé¢çš„å›åº”

postMessage.html

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
    <iframe src="http://localhost:8001/postMessage/postMessage1.html" id="frame"></iframe>
</body>
<script>
    window.onload = function () {
        const frame = document.getElementById('frame');
        frame.contentWindow.postMessage('qinhanwen', 'http://localhost:8001');
        //æ–°å¢çš„éƒ¨åˆ†
        window.onmessage = function (e) {
            console.log(e.data);
        }
        //
    }

</script>

</html>
```



postMessage1.html

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>

</body>
<script>
    window.onmessage = function (e) {
        console.log(e.data);
        //æ–°å¢çš„éƒ¨åˆ†
        e.source.postMessage('received', e.origin);
        //
    }
</script>

</html>
```

å¯ä»¥çœ‹åˆ°é¡µé¢è¾“å‡ºç»“æœ

![](http://www.qinhanwen.xyz/images/WX20181202-124832@2x.png)



#### 4.window.name

**å…³äº`window.name`å±æ€§:  name å€¼åœ¨ä¸åŒçš„é¡µé¢ï¼ˆç”šè‡³ä¸åŒåŸŸåï¼‰åŠ è½½åä¾æ—§å­˜åœ¨ï¼ˆå¦‚æœæ²¡ä¿®æ”¹åˆ™å€¼ä¸ä¼šå˜åŒ–ï¼‰ï¼Œå¹¶ä¸”å¯ä»¥æ”¯æŒéå¸¸é•¿çš„ name å€¼ï¼ˆ2MBï¼‰ã€‚å¹¶ä¸”`window.name`å¾ˆæ–¹ä¾¿ã€‚**



##### 1ï¼‰ç¬¬ä¸€ä¸ªğŸŒ°ï¼Œæ–°å»ºä¸¤ä¸ªé¡µé¢ï¼Œå¹¶ä¸”è®©è¿™ä¸¤ä¸ªé¡µé¢ä¸åŒåŸŸã€‚`name.html`å¯åœ¨ç«¯å£å·`8000`ï¼Œ`name1.html`å¯åœ¨ç«¯å£å·`8001`,æˆ‘åœ¨é¡µé¢name.htmlå»è·å–name1çš„æ•°æ®ã€‚åœ¨åŠ è½½é¡µé¢`name1.html`çš„æ—¶å€™ï¼Œè®¾ç½®`window.name='qinhanwen'`



name.html

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
    <iframe src="http://localhost:8001/windowname/name1.html" frameborder="0" onload="load()" id="frame"></iframe>
</body>
<script>
    let first = true;
    function load() {
        const frame = document.getElementById('frame');
        console.log(frame.contentWindow.name);
    }
</script>

</html>
```



name1.html

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
</body>
<script>
    window.name = 'qinhanwen';
</script>

</html>
```



ç„¶åçœ‹åˆ°æŠ¥é”™ï¼Œå› ä¸ºåŸŸä¸åŒï¼Œæ‰€ä»¥æ— æ³•è·å–ã€‚

![](http://www.qinhanwen.xyz/images/WX20181202-163052@2x.png)



#### **è§£å†³æ–¹æ¡ˆ**ï¼šæ–°å»ºä¸€ä¸ª`name2.html`æŠŠiframeçš„srcè®¾ç½®ä¸ºè¿™ä¸ªé¡µé¢ï¼Œä»–ä¸`name.html`åŒåŸŸ

name2.html     å®é™…ä¸Šè¿™ä¸ªname2.htmlä»€ä¹ˆéƒ½æ²¡åš

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    
</body>
</html>
```



name.html

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
    <iframe src="http://localhost:8001/windowname/name1.html" frameborder="0" onload="load()" id="frame"></iframe>
</body>
<script>
    let first = true;
    function load() {
        const frame = document.getElementById('frame');
        if (first) {
            first = false;
            frame.src = "http://localhost:8000/windowname/name2.html";
        }else{
            console.log(frame.contentWindow.name);
        }
    }
</script>

</html>
```



å¯ä»¥çœ‹åˆ°è·å–æˆåŠŸäº†

![](http://www.qinhanwen.xyz/images/WX20181202-163711@2x.png)



#### 5.location.hash

è·¯å¾„åçš„hashå€¼å¯ä»¥ç”¨äºé€šä¿¡

##### 1ï¼‰æ–°å»ºä¸‰ä¸ªé¡µé¢ `hash.html`ä¸`hash1.html`åŒåŸŸï¼Œä¸`hash2.html`ä¸åŒåŸŸã€‚



hash.html

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <iframe src="http://localhost:8001/location/hash2.html#qinhanwen" frameborder="0"></iframe>
</body>
</html>
```



hash2.html

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    
</body>
<script>
window.onload = function(){
    console.log(location.hash);//#qinhanwen
}
</script>
</html>
```

å¯ä»¥çœ‹åˆ°æ‰“å°å‡ºäº†   #qinhanwen



##### 2ï¼‰é‚£ä¹ˆè¦æ€ä¹ˆä¼ é€’ç»™å€¼ç»™çˆ¶çª—ä½“

ä½¿ç”¨`window.parent.hash`

æˆ‘ä»¬æŠŠçˆ¶çª—ä½“çš„hashè®¾ç½®ä¸º#qinhanwen

hash2.html

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    
</body>
<script>
window.onload = function(){
    console.log(location.hash);
    //æ–°å¢çš„éƒ¨åˆ†
    window.parent.location.hash = '#qinhanwen';
    //
}
</script>
</html>
```



ç„¶åçœ‹åˆ°æŠ¥é”™ï¼Œä¸åŒåŸŸçš„è¯ï¼Œæ˜¯ä¸å…è®¸æ“ä½œçˆ¶çª—ä½“hashå€¼çš„

![](http://www.qinhanwen.xyz/images/WX20181202-183016@2x.png)





**è§£å†³æ–¹æ¡ˆ**ï¼šæ–°å¢ä¸€ä¸ª`hash1.html`é¡µé¢ï¼Œåœ¨`hash2.html`ä¸­æ·»åŠ ä¸€ä¸ªiframeï¼Œiframseçš„ srcæŒ‡å‘ä¸`hash.html`åŒåŸŸçš„`hash1.html`åœ°å€ï¼Œè€Œåœ¨`hash1.html`è®¾ç½®çˆ¶äº²çš„çˆ¶äº²çª—ä½“çš„hashå€¼ï¼Œçœ‹ğŸŒ°



hash1.html

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    
</body>
<script>
window.onload = function(){
    window.parent.parent.location.hash = '#qinhanwen';
}
</script>
</html>
```



hash2.html

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    
</body>
<script>
window.onload = function(){
    console.log(location.hash);
    let iframe = document.createElement('iframe');
    iframe.src = "http://localhost:8000/location/hash1.html#qinhanwen";
    document.body.appendChild(iframe);
}
</script>
</html>
```



å¯ä»¥çœ‹åˆ°hashè¢«è®¾ç½®ä¸ºäº†#qinhanwen

![](http://www.qinhanwen.xyz/images/WX20181202-183956@2x.png)

##### 3ï¼‰hashå€¼æ˜¯æ”¹å˜äº†ï¼Œæ€ä¹ˆå–å¾—å‘¢

hash.html

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <iframe src="http://localhost:8001/location/hash2.html#qinhanwen" frameborder="0"></iframe>
</body>
    
<!--æ–°å¢çš„éƒ¨åˆ†-->
<script>
window.onhashchange = function(){
    console.log(location.hash);
}
</script>
<!---->
    
</html>
```





#### 6.document.domain

è¿™ä¸ªè¦å…ˆäº†è§£ä¸€çº§åŸŸåå’ŒäºŒçº§åŸŸåï¼Œå¤§æ¦‚è§†é¢‘80åˆ†é’Ÿçš„æ—¶å€™å¼€å§‹è¯´ã€‚



#### 7.WebSocket

[WebSocket+koa](https://qinhanwen.github.io/2018/11/05/websocket+koa/)



#### 8.Nginx

å¤§æ¦‚è§†é¢‘90å¤šåˆ†é’Ÿå¼€å§‹è¯´ã€‚





