---
title: ä¸ƒç‰›äº‘æµ‹è¯•åŸŸåè¿‡æœŸ
date: 2018-12-15 11:06:25
tags: 
- puppeteer
categories: 
- puppeteer
---

##### èƒŒæ™¯ï¼šæœ‰ä¸€å¤©çªç„¶å‘ç°ä¸ƒç‰›äº‘æµ‹è¯•åŸŸåè¢«å›æ”¶äº†ï¼Œæœ‰äº›å›¾ç‰‡æ˜¾ç¤ºä¸å‡ºæ¥äº†ï¼Œå›¾ç‰‡ä¹Ÿä¸èƒ½ç›´æ¥ä¸‹è½½ï¼Œæœ¬åœ°è¿˜æ²¡æœ‰å¤‡ä»½ã€‚äºæ˜¯ä¹æƒ³åˆ°çš„åŠæ³•å°±æ˜¯æ‰“å¼€ä¸€å¼ å¼ å›¾ç‰‡é“¾æ¥ï¼Œæ‰‹åŠ¨ä¿å­˜åˆ°æœ¬åœ°ã€‚ä½œä¸ºä¸€åªç¨‹åºğŸ’ï¼Œè¿™ç§äº‹æƒ…è‡ªç„¶æ˜¯åšä¸å‡ºæ¥çš„ï¼ŒæŸ¥äº†ä¸€å †èµ„æ–™éƒ½è§‰å¾—éº»çƒ¦ï¼Œæ‰€ä»¥ç”¨è‡ªå·±çš„æ–¹å¼è§£å†³é—®é¢˜ï¼Œå½“ç„¶ä¹Ÿæœ‰[è§£å†³æ–¹æ¡ˆ](https://blog.csdn.net/lkj345/article/details/83382636)ã€‚



##### æƒ³æ³•ï¼šå…¶å®æƒ³æ³•å°±æ˜¯

###### 1.ç™»é™†ä¸ƒç‰›äº‘

###### 2.è·³è½¬åˆ°å¯¹åº”çš„é¡µé¢

###### 3.åŠ è½½å®Œæˆçš„å›¾ç‰‡åˆ—è¡¨ï¼Œå¹¶ä¸”è·å–å…¨éƒ¨å›¾ç‰‡çš„åå­—ï¼ˆå› ä¸ºæˆ‘åªæœ‰80å¼ ï¼Œæ‰€ä»¥åªéœ€è¦ç‚¹å‡»ä¸€æ¬¡åŠ è½½æ›´å¤šï¼Œå°±å¯ä»¥è·å–å…¨éƒ¨åˆ—è¡¨ï¼‰

###### 4.æ‰“å¼€å›¾ç‰‡å®Œæ•´è·¯å¾„ï¼Œä¸‹è½½å›¾ç‰‡åˆ°æœ¬åœ°



#### ä½¿ç”¨[puppeteer](https://qinhanwen.github.io/2018/11/16/puppeteer%E5%B0%8F%E8%AF%95%E7%89%9B%E5%88%80/)æ¥è§£å†³é—®é¢˜

```javascript
const puppeteer = require('puppeteer');

function timeout(delay) {
    return new Promise(resolve => {
        setTimeout(
            () => {
                resolve()
            }, delay
        )
    })
}

var userInfo = {
    name: 'è´¦å·',
    pwd: 'å¯†ç ',
    domaiName: 'æµ‹è¯•åŸŸå'
};

(async () => {
    const browser = await puppeteer.launch({
        executablePath: './chrome-mac/Chromium.app/Contents/MacOS/Chromium',
        headless: false
    });//æ— å¤´æ¨¡å¼é»˜è®¤æ˜¯trueï¼Œè®¾ç½®ä¸ºfalse
    const page = await browser.newPage();
    const viewConfig = {
        width: 1080,
        height: 1920
    };
    //è®¾ç½®çª—å£ 
    page.setViewport(viewConfig);
    await page.goto('https://portal.qiniu.com/bucket/picture/resource');

    page.on('error', (err) => {
        console.log(err);
    })

    //ç™»å½•
    await page.waitForSelector('#email');
    await page.type('#email', userInfo.name);
    await page.type('#password', userInfo.pwd);
    await page.tap('#login-button');

    //ç‚¹å‡»å·¦ä¾§ å¯¹è±¡å­˜å‚¨çš„æŒ‰é’®
    await page.waitForSelector('.sidebar-item');
    const sidebarList = await page.$$('.sidebar-item');
    await sidebarList[4].tap();

    //ç‚¹å‡»å†…å®¹ç®¡ç†
    await page.waitForSelector('.basic-operation>a');
    await timeout(3000);
    const breadcrumbList = await page.$$('.basic-operation>a');
    await breadcrumbList[2].tap();

    //ç‚¹å‡»åŠ è½½æ›´å¤š
    await timeout(3000);
    await page.waitForSelector('.text-center>a');
    await page.tap('.text-center>a');

    //è·å–åˆ—è¡¨å›¾ç‰‡åç§°ä¿¡æ¯
    await timeout(3000);
    await page.waitForSelector('.file-td');
    let list = await page.$$eval('.file-td', el => {
        let arr = [];
        const len = el.length;
        for(let i=0;i<len;i++){
            arr.push(el[i].textContent);
        }
        return arr;
    });
    console.log(list);
    await browser.close();
})();
```



#### è¿™æ ·å°±æ‹¿åˆ°äº†å›¾ç‰‡çš„åç§°çš„æ•°ç»„äº†ï¼Œæƒ³åˆ°ä¸¤ç§æ–¹å¼æ¥ä¸‹è½½

##### 1.å°±ä½¿ç”¨puppeteerçš„æˆªå›¾ï¼Œç›´æ¥è´´å…¨éƒ¨ä»£ç 

```javascript
const puppeteer = require('puppeteer');

function timeout(delay) {
    return new Promise(resolve => {
        setTimeout(
            () => {
                resolve()
            }, delay
        )
    })
}

var userInfo = {
    name: 'è´¦å·',
    pwd: 'å¯†ç ',
    domaiName: 'æµ‹è¯•åŸŸå'
};

(async () => {
    const browser = await puppeteer.launch({
        executablePath: './chrome-mac/Chromium.app/Contents/MacOS/Chromium',
        headless: false
    });//æ— å¤´æ¨¡å¼é»˜è®¤æ˜¯trueï¼Œè®¾ç½®ä¸ºfalse
    const page = await browser.newPage();
    const viewConfig = {
        width: 1080,
        height: 1920
    };
    //è®¾ç½®çª—å£ 
    page.setViewport(viewConfig);
    await page.goto('https://portal.qiniu.com/bucket/picture/resource');

    page.on('error', (err) => {
        console.log(err);
    })

    //ç™»å½•
    await page.waitForSelector('#email');
    await page.type('#email', userInfo.name);
    await page.type('#password', userInfo.pwd);
    await page.tap('#login-button');

    //ç‚¹å‡»å·¦ä¾§ å¯¹è±¡å­˜å‚¨çš„æŒ‰é’®
    await page.waitForSelector('.sidebar-item');
    const sidebarList = await page.$$('.sidebar-item');
    await sidebarList[4].tap();

    //ç‚¹å‡»å†…å®¹ç®¡ç†
    await page.waitForSelector('.basic-operation>a');
    await timeout(3000);
    const breadcrumbList = await page.$$('.basic-operation>a');
    await breadcrumbList[2].tap();

    //ç‚¹å‡»åŠ è½½æ›´å¤š
    await timeout(3000);
    await page.waitForSelector('.text-center>a');
    await page.tap('.text-center>a');

    //è·å–åˆ—è¡¨å›¾ç‰‡åç§°ä¿¡æ¯
    await timeout(3000);
    await page.waitForSelector('.file-td');
    let list = await page.$$eval('.file-td', el => {
        let arr = [];
        const len = el.length;
        for (let i = 0; i < len; i++) {
            arr.push(el[i].textContent);
        }
        arr.splice(0,1);
        return arr;
    });
    
    //æˆªå›¾
    list = list.map(item=>item.replace(/(^\s*)|(\s*$)/g, ""));
    const len = list.length;
    for (let i = 0; i < len; i++) { 
        await page.goto(userInfo.domaiName+list[i]);
        const img = await page.$('img');
        if(img){
            const boundingBox = await img.boundingBox();
            await page.screenshot({path:'./images/'+list[i],clip: boundingBox});
        }else{
            await page.screenshot({path:'./images/'+list[i]});
        }
    }

    await browser.close();
})();
```

ç„¶é¹…ï¼Œæœ‰ä¸€äº›å·²ç»é“¾æ¥å¤±æ•ˆäº†ï¼Œå·®ç‚¹åˆšåƒè¿›å»çš„è€å›é…¸èœä¸€å£åå‡ºæ¥ã€‚

[ç‚¹å‡»è¿™é‡Œï¼Œå¯ä»¥çœ‹åˆ°æ•ˆæœ](http://www.qinhanwen.xyz/images/Dec-17-2018 12-56-03.mp4)

##### 2.Node.js

###### 1ï¼‰å®‰è£…request

```shell
$ npm install request
```



###### 2ï¼‰å®ç°

```javascript
var fs = require('fs');
var request = require("request");

var list = ["0.png", "1542689394373.jpg", "1542690089176.jpg"];

const doMain = 'æµ‹è¯•åŸŸå';//ä½ çš„æµ‹è¯•åŸŸå

function download(name) {
    var src = doMain + name;
    var writeStream = fs.createWriteStream('images/' + name);//å›¾ç‰‡å†™å…¥ç›®æ ‡è·¯å¾„
    var readStream = request(src);
    readStream.pipe(writeStream);
    readStream.on('end', function () {
        console.log('æ–‡ä»¶ä¸‹è½½æˆåŠŸ');
    });
    readStream.on('error', function () {
        console.log("é”™è¯¯ä¿¡æ¯:" + err)
    })
    writeStream.on("finish", function () {
        console.log("æ–‡ä»¶å†™å…¥æˆåŠŸ");
        writeStream.end();
    });
}
const len = list.length;

for (let i = 0; i < len; i++) {
    download(list[i]);
}
```

ä¸è¿‡è¿™é‡Œä¸‹è½½çš„å›¾ç‰‡æœ‰ç‚¹é—®é¢˜ï¼Œè¿˜æ²¡æƒ³åˆ°æ€ä¹ˆè§£å†³ã€‚

##### 3ï¼‰ä½¿ç”¨canvasç»˜åˆ¶å›¾ç‰‡ï¼Œå¹¶ä¸”è½¬æˆBLOBå¯¹è±¡ï¼Œå†ä½¿ç”¨aæ ‡ç­¾è¿›è¡Œä¸‹è½½ã€‚

ä¸€å¼€å§‹æƒ³ä½¿ç”¨`a`æ ‡ç­¾çš„`download`å±æ€§ï¼Œç„¶è€Œ`a`æ ‡ç­¾åªæ”¯æŒåŒæºçš„URLã€‚æ‰€ä»¥æ‰ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
    <canvas id="canvas">

    </canvas>
</body>
<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext("2d");

    //åˆ›å»ºæ–°çš„å›¾ç‰‡å¯¹è±¡
    var img = new Image();
    //è§£å†³è·¨åŸŸå›¾ç‰‡é—®é¢˜
    img.crossOrigin = "Anonymous";
    //æŒ‡å®šå›¾ç‰‡çš„URL
    img.src = "http://pi8irywwe.bkt.clouddn.com/0.png";
    //æµè§ˆå™¨åŠ è½½å›¾ç‰‡å®Œæ¯•åå†ç»˜åˆ¶å›¾ç‰‡
    img.onload = function () {
        canvas.width = img.width;
        canvas.height = img.height;
        //ä»¥Canvasç”»å¸ƒä¸Šçš„åæ ‡(10,10)ä¸ºèµ·å§‹ç‚¹ï¼Œç»˜åˆ¶å›¾åƒ
        ctx.drawImage(img, 10, 10);
        //ä¸‹è½½å›¾ç‰‡
        canvas.toBlob(function (blob) {
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.download = '0.png';
            link.click();
        });
    };
</script>

</html>
```



> å‚è€ƒèµ„æ–™ï¼š[aæ ‡ç­¾](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/a) 

