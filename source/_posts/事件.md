---
title: äº‹ä»¶
date: 2018-12-25 23:04:14
tags: 
- æ·±å…¥å­¦ä¹ 
categories: 
- æ·±å…¥å­¦ä¹ 
---

> å‚è€ƒèµ„æ–™ï¼šhttps://www.bitovi.com/blog/a-crash-course-in-how-dom-events-work

# äº‹ä»¶

#### äº‹ä»¶ç›‘å¬

##### 1.æ€æ ·ç›‘å¬ä¸€ä¸ªäº‹ä»¶

###### DOM0

```html
<button onclick="alert('hello');">
   click me! 
</button>
```

è¿™ç§ç›´æ¥å°†äº‹ä»¶æ··åˆåœ¨HTMLä¸­ï¼Œéå¸¸çš„ä¸çµæ´»



###### DOM1

```javascript
var button = document.getElementById('button');
button.onclick = function(){
    alert('click me!')
}
```

è¿™ç§æ–¹å¼ç›¸å¯¹äºå‰ä¸€ç§ï¼Œåˆ†ç¦»äº†HTMLå’ŒJavaScriptï¼Œä½†æ˜¯åªèƒ½ä¸ºä¸€ä¸ªå…ƒç´ ç»‘å®šäº‹ä»¶



###### DOM2

```javascript
var button = document.getElementById('button');
button.addEventListener('click',function(){
	alert('click me!')
},false)
```

é€šè¿‡`addEventListener`å¯ä»¥è®©æˆ‘ä»¬å¯¹äº‹ä»¶å†™æ›´å¤šçš„å¤„ç†ç¨‹åºï¼Œä¸‹é¢ä¼šè¯´`addEventListener`çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼ˆå¯ä»¥æ§åˆ¶äº‹ä»¶åœ¨å†’æ³¡é˜¶æ®µè¿˜æ˜¯æ•è·é˜¶æ®µè§¦å‘ï¼‰ã€‚



##### 2.äº‹ä»¶åœ¨æ–‡æ¡£ä¸­æ€ä¹ˆç©¿æ¢­

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
    <div id="myDiv">
        <a id="myAnchor" href="https://qinhanwen.github.io/">qinhanwen!
        </a>
    </div>
</body>
<script>
    var html = document.documentElement;
    var body = document.body;
    var div = document.getElementById('myDiv');
    var a = document.getElementById('myAnchor');

    function handles(e) {
        console.log(e.currentTarget);
    }
    html.addEventListener('click', handles, true);
    body.addEventListener('click', handles, true);
    div.addEventListener('click', handles, true);
    a.addEventListener('click', handles, true);
</script>

</html>
```

æˆ‘ä»¬ä¸ºæ ¹å…ƒç´ ï¼Œbodyï¼Œdivï¼Œaæ·»åŠ ç›‘å¬äº‹ä»¶ï¼Œå¹¶ä¸”`addEventListener`ç¬¬ä¸‰ä¸ªå‚æ•°å€¼ä¸ºfalseï¼ˆé»˜è®¤ä¸ºfalseï¼‰ï¼Œhandleråœ¨å†’æ³¡é˜¶æ®µè°ƒç”¨ã€‚

ç‚¹å‡»aä¹‹åçœ‹åˆ°æ‰“å°å‡º`a => div =>  body => html`

![WX20190105-000222@2x](http://www.qinhanwen.xyz/WX20190105-000222@2x.png)



ä¿®æ”¹ä¸€ä¸‹`addEventListener`ç¬¬ä¸‰ä¸ªå‚æ•°å€¼ä¸ºtrueï¼Œhandleråœ¨æ•è·é˜¶æ®µæ‰§è¡Œ

![WX20190105-000914@2x](http://www.qinhanwen.xyz/WX20190105-000914@2x.png)

ç‚¹å‡»aä¹‹åçœ‹åˆ°æ‰“å°å‡º` html => body => div => a`



##### 3.æµè§ˆå™¨åšäº†ä»€ä¹ˆï¼ˆç”¨ä»£ç æ¥è¡¨ç°äº‹ä»¶åœ¨æµè§ˆå™¨ä¸­çš„è¡Œä¸ºï¼‰

###### 1ï¼‰`element.addEventListener`

```javascript
HTMLNode.prototype.addEventListener = 
  function(eventName, handler, phase){
    // Make a __handlers object on 
    // this element if there is none already
    if(!this.__handlers){
      this.__handlers = {};
    }

    // If there are no event handler lists for 
    //  this event, add them
    if(!this.__handlers[eventName]){
      this.__handlers[eventName] = 
        {capture : [], bubble: []};
    }

    // Add the new handler function 
    //  to the specified phase list
    this.__handlers[eventName]
        [phase ? 'capture' : 'bubble'].push(handler);
}
```

addEventListeneræ¥å—3ä¸ªå‚æ•°ï¼Œäº‹ä»¶åï¼Œå›è°ƒï¼Œé˜¶æ®µï¼Œå¦‚æœthis.handlersä¸å­˜åœ¨ï¼Œå°±åˆ›å»ºä¸€ä¸ªå¯¹è±¡ã€‚å¦‚æœè¿™ä¸ªå¯¹è±¡æ²¡æœ‰å¯¹åº”äº‹ä»¶çš„valueï¼Œè®¾ç½®è¿™ä¸ªå¯¹åº”äº‹ä»¶çš„valueä¸º{capture : [], bubble: []}ï¼Œç„¶ååˆ¤æ–­phaseï¼Œå°†handlerå‹è¿›å¯¹åº”çš„æ•°ç»„ã€‚



###### 2ï¼‰äº‹ä»¶æ˜¯æ€æ ·è¢«è°ƒç”¨çš„

```javascript
Handle = function(ev){

  // ç¬¬ä¸€æ­¥
    
  var elements = [],//å£°æ˜ä¸€ä¸ªelementsæ•°ç»„
    target = ev.target,//ev.targetå°±æ˜¯è§¦å‘çš„ç›®æ ‡å…ƒç´ 
    isPropagationStopped = false,//è®¾ç½®isPropagationStoppedæ˜¯å¦é˜»æ­¢è¡Œä¸ºä¸ºfalse
    isDefaultPrevented = false;//isDefaultPreventedæ˜¯å¦é˜»æ­¢é»˜è®¤è¡Œä¸ºä¸ºfalse

  ev.eventPhase = 1;

  ev.stopPropagation = function(){//è®¾ç½®é˜»æ­¢è¡Œä¸ºçš„æ–¹æ³•ï¼Œå»ä¿®æ”¹isPropagationStoppedçš„å€¼ä¸ºtrue(è¿™ä¸ªäº‹ä»¶ä¼šé˜»æ­¢å†’æ³¡æˆ–æ•è·ï¼Œä¸‹é¢ä¸¾ä¾‹å­)
    isPropagationStopped = true;
  }

  ev.preventDefault = function(){//è®¾ç½®é˜»æ­¢é»˜è®¤äº‹ä»¶çš„æ–¹æ³•ï¼Œå»ä¿®æ”¹isDefaultPreventedçš„å€¼ä¸ºtrue
    isDefaultPrevented = true;
  }

  //ç¬¬äºŒæ­¥
    
  do{
    elements.push(target);//å‘elementsé‡Œå‹è¿›target
  }while((target = target.parentNode)); //æŠŠtargetçš„çˆ¶èŠ‚ç‚¹èµ‹å€¼ç»™targetï¼Œç›´åˆ°targetçˆ¶èŠ‚ç‚¹ä¸ºç©ºçš„æ—¶å€™ï¼Œå¾ªç¯ç»ˆæ­¢

  elements.reverse();//è·å–çš„elementsæ•°ç»„ï¼Œæ’åºæ˜¯ä»é‡Œåˆ°å¤–ï¼Œè€Œæ•è·æ˜¯ä»å¤–åˆ°é‡Œï¼Œæ‰€ä»¥æ•°ç»„åè½¬ä¸€ä¸‹

  
  //ç¬¬ä¸‰æ­¥
  
  //éå†elementsæ•°ç»„
  for(var i = 0 ; i < elements.length; i++){

  
    if(isPropagationStopped){//å¦‚æœé˜»æ­¢è¡Œä¸ºï¼Œå°±è·³å‡ºå¾ªç¯
      break;
    }

    var currentElement = elements[i],//currentElementå˜é‡ä¿å­˜éå†çš„å½“å‰å…ƒç´ 

      //å¦‚æœè¿™ä¸ªå…ƒç´ æœ‰ç»‘å®šhandlerï¼Œtypeå’Œphaseï¼ŒæŠŠæ•°ç»„èµ‹å€¼ç»™handlersï¼Œå¦åˆ™è®¾ç½®å®ƒä¸ºä¸€ä¸ªç©ºæ•°ç»„
        handlers = currentElement.__handlers
          && currentElement.__handlers[ev.type]
          && currentElement.__handlers[ev.type].capture 
          || [];

    ev.currentTarget = currentElement;//è®¾ç½®currentTargetä¸ºå½“å‰çš„è¿™ä¸ªå…ƒç´ 

    //å¾ªç¯è°ƒç”¨handlersé‡Œçš„å›è°ƒ(å¦‚æœæœ‰å¤šä¸ªç›‘å¬äº‹ä»¶çš„è¯ï¼Œhandlersæ•°ç»„çš„å…ƒç´ ä¼šæœ‰å¤šä¸ª)
    for(var h = 0; i < handlers.length; h++){
      handlers[h].call(currentElement, ev);
    }
  }

  //ç¬¬å››æ­¥
  if(!isPropagationStopped){
    ev.target["on" + ev.type].call(ev.target, ev);//è§¦å‘DOM1äº‹ä»¶
  }

  elements.reverse();//å†’æ³¡é˜¶æ®µä»é‡Œåˆ°å¤–ï¼Œæ‰€ä»¥å†æ¬¡åè½¬æ•°ç»„
  ev.eventPhase = 3;


  //ç¬¬äº”æ­¥


  for(var i = 0 ; i < elements.length; i++){//éå†elements
    if(isPropagationStopped){
      break;
    }

    //è·Ÿä¸Šé¢çš„æ•è·ç›¸åï¼Œè¿™é‡Œæ˜¯å†’æ³¡
    var currentElement =  elements[i],
      handlers = currentElement.__handlers 
        && currentElement.__handlers[ev.type]
        && currentElement.__handlers[ev.type].bubble 
        || [];

    ev.currentTarget = currentElement;

    //å¾ªç¯è°ƒç”¨handlersé‡Œçš„å›è°ƒ(å¦‚æœæœ‰å¤šä¸ªç›‘å¬äº‹ä»¶çš„è¯ï¼Œhandlersæ•°ç»„çš„å…ƒç´ ä¼šæœ‰å¤šä¸ª)
    for(var h = 0 ; i < handlers.length; h++){
      handlers[h].call(currentElement,ev);
    }
  }

  //ç¬¬å…­æ­¥

  // å…ƒç´ çš„é»˜è®¤è¡Œä¸º
  if(!isDefaultPrevented){//å¦‚æœæ²¡æœ‰é˜»æ­¢é»˜è®¤è¡Œä¸º(è¿™é‡Œæ˜¯aå…ƒç´ çš„)

    if(ev.type == "click" 
      && ev.target.nodeName.toLowerCase() == "a"){
      window.location = ev.target.href;
    }

  }
}
```



é€šè¿‡ä¸Šé¢ä»£ç ä¼ªå®ç°å¯ä»¥çœ‹åˆ°**stopPropagation**åœ¨æ•è·å’Œå†’æ³¡é˜¶æ®µéƒ½æœ‰èµ·ä½œç”¨ã€‚



#### æ€»ç»“

###### 1.element.addEventListeneræ–¹æ³•ï¼Œä¼šåˆ¤æ–­ç¬¬ä¸‰ä¸ªå‚æ•°phaseï¼ˆé»˜è®¤æ˜¯falseï¼‰ï¼Œå¦‚æœæ˜¯trueå°±å£°æ˜ï¼ˆæˆ–è€…å‘å·²å£°æ˜çš„ï¼‰captureæ•°ç»„é‡Œpushè¿›å‡½æ•°ã€‚å¦‚æœæ˜¯falseå°±å‘bubbleæ•°ç»„å†…pushè¿›å‡½æ•°

###### 2.å‡è®¾ç›‘å¬çš„æ˜¯clickäº‹ä»¶ï¼Œåœ¨ç‚¹å‡»ç›®æ ‡å…ƒç´ çš„æ—¶å€™ï¼Œè®¡ç®—è·¯å¾„ï¼Œç”±å†…åˆ°å¤–çš„è·å–èŠ‚ç‚¹å¹¶ä¸”pushåˆ°elementsæ•°ç»„é‡Œï¼Œåè½¬elementsæ•°ç»„ï¼ˆå˜æˆä»å¤–åˆ°å†…ï¼‰ï¼Œç„¶åéå†elementsæ•°ç»„ï¼ˆå¦‚æœæœ‰è°ƒç”¨stopPropagationå°±è·³å‡ºå¾ªç¯ï¼‰ï¼Œéå†elementsä¸­æ¯ä¸ªèŠ‚ç‚¹çš„captureæ•°ç»„ï¼Œå¹¶ä¸”è°ƒç”¨ã€‚

###### 3.è°ƒç”¨è¢«ç‚¹å‡»å…ƒç´ çš„DOM1äº‹ä»¶ï¼Œå†æ¬¡åè½¬elementsæ•°ç»„ï¼Œå˜æˆä»å†…åˆ°å¤–ã€‚

###### 4.éå†elementsæ•°ç»„çš„ï¼Œéå†æ¯ä¸ªèŠ‚ç‚¹çš„bubbleæ•°ç»„ï¼Œå¹¶ä¸”è°ƒç”¨ã€‚

###### 5.å¦‚æœæ²¡æœ‰è°ƒç”¨preventDefaultæ–¹æ³•ï¼Œå°±æ˜¯è°ƒç”¨æ ‡ç­¾çš„é»˜è®¤è¡Œä¸ºï¼ˆæ¯”å¦‚aæ ‡ç­¾çš„è·³è½¬ï¼‰ã€‚





#### æ€»ç»“ä¹‹åå‘ç°æ¼äº† äº‹ä»¶ä»£ç†ï¼Œèµ¶ç´§è¡¥ä¸€ä¸‹

å…¶å®è¯´çš„æ¯”è¾ƒç®€å•å°±æ˜¯ï¼šæœ‰100ä¸ªliå…ƒç´ ï¼Œæˆ‘ç‚¹å‡»äº†æŸä¸ªliå…ƒç´ ï¼Œäºæ˜¯å†’æ³¡åˆ°äº†ulï¼Œè§¦å‘äº†ulçš„ç›‘å¬äº‹ä»¶ï¼Œç„¶ååœ¨è¿™é‡Œå†å¯¹ç‚¹å‡»äº‹ä»¶åšå¤„ç†ã€‚

ç›´æ¥å†™ğŸŒ°å§

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
    <ul id="ul">

    </ul>
</body>
<script>
    var arr = [1, 2, 3, 4, 5, 6];
    var str = '';
    var ul = document.getElementById('ul');
    ul.addEventListener('click', function (e) {
        console.log(e.target.dataset.id);
    })
    arr.forEach(function (i) {
        str += '<li data-id="' + i + '">' + i + '</li>'
    })
    ul.innerHTML = str;
</script>

</html>
```

å…¶å®æˆ‘ä»¬åšçš„äº‹æƒ…å°±æ˜¯ä¸º`li`æ·»åŠ äº†è‡ªå®šä¹‰å±æ€§ï¼Œç„¶åç‚¹å‡»çš„æ—¶å€™å†’æ³¡ï¼Œæ‰“å°å‡ºè¢«ç‚¹å‡»çš„å…ƒç´ çš„è‡ªå®šä¹‰å±æ€§ã€‚

æˆ‘ä»¬åˆ†åˆ«ç‚¹å‡»1åˆ°6ï¼Œçœ‹åˆ°æ§åˆ¶å°æ‰“å°å‡ºäº†è‡ªå®šä¹‰çš„`id`

![WX20190111-222400@2x](http://www.qinhanwen.xyz/WX20190111-222400@2x.png)

å—¯ï¼Œå¤§æ¦‚å°±è¿™æ ·å­ï¼Œé‚£ä¹ˆå®ƒçš„æœ‰ä¼˜ç‚¹æ˜¯ï¼š

â€‹	é¦–å…ˆï¼Œæ¯ä¸ªå‡½æ•°éƒ½æ˜¯å¯¹è±¡ï¼Œæˆ‘å¦‚æœä¸ºæ¯ä¸ª`li`éƒ½æ·»åŠ çš„è¯ï¼Œå¦‚æœæ•°é‡å¾ˆå¤šçš„è¯ï¼Œä¼šå ç”¨å¾ˆå¤šå†…å­˜ï¼Œå½±å“æ€§èƒ½ã€‚ç„¶åï¼Œç½‘ä¸Šå¾ˆå¤šäººè¯´å¤„ç†ç¨‹åºè¶Šå¤šï¼Œéœ€è¦ä¸æ–­çš„å¯¹DOMæ“ä½œï¼Œä¼šå¯¼è‡´æµè§ˆå™¨ä¸æ–­çš„å›æµå’Œé‡ç»˜ï¼Œå…¶å®è¿™ç‚¹æˆ‘è§‰å¾—åƒä¹‹å‰çš„è¿™ç§ï¼Œç‚¹å‡»æŸä¸ªliï¼Œå¤§æ¦‚å°±æ˜¯æ”¹ä¸ªé¢œè‰²æˆ–è€…æ”¹ä¸€ä¸‹liçš„å†…å®¹ï¼Œåº”è¯¥å’Œå†’æ³¡åˆ°ulä¹‹åå†å¤„ç†æ˜¯å·®ä¸å¤šçš„ï¼Œè¿™ç‚¹è¿˜æ²¡èƒ½å¾ˆå¥½çš„ç†è§£ï¼Œä¹‹åç†è§£äº†å†æ¥æ”¹ã€‚

ç¼ºç‚¹ï¼šå®ƒæ˜¯åˆ©ç”¨å†’æ³¡ï¼Œå¦‚æœæœ‰ä¸€äº›å…ƒç´ æ²¡æœ‰å†’æ³¡ï¼Œæ¯”å¦‚inputã€‚

















